

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Modelos Multinivel &#8212; Análisis Geoespacial</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'CAR';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Análisis Geoespacial - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="Análisis Geoespacial - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    <no title>
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="00_Ambiente.html">Ambiente computacional</a></li>
<li class="toctree-l1"><a class="reference internal" href="01_DatosEspaciales.html">Análisis Geoespacial</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_Mapping.html">El arte de hacer mapas</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_PointPattern.html">Patrón de puntos</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_GLMPhyton.html">Modelos Lineales Generalizados (GML)</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_Coropleta.html">Visualización de datos discretos</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_MatrizCorrelacion.html">Matriz espacial</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_ClusterEspacial.html">Cluster espacial</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_SpatialRegression.html">Regresión Espacial</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_SAR.html">Modelos de regresión para dependencia espacial tipo SAR</a></li>
<li class="toctree-l1"><a class="reference internal" href="11_CAR.html">Modelos de regresión para dependencia espacial tipo CAR</a></li>
<li class="toctree-l1"><a class="reference internal" href="12_Jerarquicos.html">Modelos de Regresión para Heterogeneidad Espacial</a></li>
<li class="toctree-l1"><a class="reference internal" href="13_MGWR.html">Regresión Ponderada Geográficamente (GWR)</a></li>
<li class="toctree-l1"><a class="reference internal" href="14_Kriging.html">Kriging con Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="15_GP.html">Procesos Gaussianos con Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="16_GP.html">Procesos Gaussianos con R</a></li>
<li class="toctree-l1"><a class="reference internal" href="17_LGCP.html">Modelo GLM de Poisson no-homogéneo</a></li>
<li class="toctree-l1"><a class="reference internal" href="18_DB.html">Bases de datos geoespaciales</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/edieraristizabal/Libro_AnalisisGeoespacial" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/edieraristizabal/Libro_AnalisisGeoespacial/issues/new?title=Issue%20on%20page%20%2FCAR.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/CAR.Rmd" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.Rmd</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Modelos Multinivel</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Modelos Multinivel</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#datos-areales-con-inla-markov">Datos areales con INLA (Markov)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelos-mixtos-lineales">Modelos mixtos lineales</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#regresion-con-efectos-aleatorios">Regresión con efectos aleatorios</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelos-espaciales-para-datos-tipo-poligonos">Modelos espaciales para datos tipo poligonos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelos-de-regresion">Modelos de Regresión</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-icar">Modelo ICAR</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-bym-besag-york-y-mollie">Modelo BYM (Besag, York y Mollié)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-de-leroux-et-al">Modelo de Leroux et al.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-lag-model-slm">Spatial Lag Model (SLM)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resultados">Resultados</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelos-espaciales-con-spamm">Modelos espaciales con spaMM</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-no-espacial">Modelo no espacial</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-espacial">Modelo espacial</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="modelos-multinivel">
<h1>Modelos Multinivel<a class="headerlink" href="#modelos-multinivel" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#### Set up a square lattice region</span>
<span class="n">x</span><span class="o">.</span><span class="n">easting</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="p">:</span><span class="mi">10</span>
<span class="n">x</span><span class="o">.</span><span class="n">northing</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="p">:</span><span class="mi">10</span>
<span class="n">Grid</span> <span class="o">&lt;-</span> <span class="n">expand</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">easting</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">northing</span><span class="p">)</span>
<span class="n">K</span> <span class="o">&lt;-</span> <span class="n">nrow</span><span class="p">(</span><span class="n">Grid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span>  <span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
    <span class="n">x</span><span class="o">.</span><span class="n">easting</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="p">:</span><span class="mi">10</span>
    <span class="o">^</span>
<span class="ne">SyntaxError</span>: illegal target for annotation
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#### set up distance and neighbourhood (W, based on sharing a common border) matrices</span>
<span class="n">distance</span> <span class="o">&lt;-</span> <span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">Grid</span><span class="p">))</span>
<span class="n">W</span> <span class="o">&lt;-</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
<span class="n">W</span><span class="p">[</span><span class="n">distance</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;-</span><span class="mi">1</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#### Generate the number of individuals per area and which individuals to which areas</span>
<span class="n">n</span> <span class="o">&lt;-</span> <span class="n">sample</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="n">n</span><span class="o">.</span><span class="n">total</span> <span class="o">&lt;-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">ind</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">temp</span> <span class="o">&lt;-</span> <span class="n">rep</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">K</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">ind</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;-</span> <span class="n">sample</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">total</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">FALSE</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#### Generate the covariates and response data</span>
<span class="n">x1</span> <span class="o">&lt;-</span> <span class="n">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>
<span class="n">x2</span> <span class="o">&lt;-</span> <span class="n">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>
<span class="n">phi</span> <span class="o">&lt;-</span> <span class="n">mvrnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">rep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">K</span><span class="p">),</span> <span class="n">Sigma</span><span class="o">=</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">distance</span><span class="p">))</span>
<span class="n">phi</span><span class="o">.</span><span class="n">extend</span> <span class="o">&lt;-</span> <span class="n">phi</span><span class="p">[</span><span class="n">ind</span><span class="o">.</span><span class="n">area</span><span class="p">]</span>
<span class="n">logit</span> <span class="o">&lt;-</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">phi</span><span class="o">.</span><span class="n">extend</span>
<span class="n">prob</span> <span class="o">&lt;-</span> <span class="n">exp</span><span class="p">(</span><span class="n">logit</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">exp</span><span class="p">(</span><span class="n">logit</span><span class="p">))</span>
<span class="n">trials</span> <span class="o">&lt;-</span> <span class="n">rep</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="n">n</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">&lt;-</span> <span class="n">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">total</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="n">prob</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#### Run the model</span>
<span class="n">formula</span> <span class="o">&lt;-</span> <span class="n">Y</span> <span class="o">~</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span>

<span class="c1">#### Toy example for checking</span>
<span class="n">model</span> <span class="o">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">CARmultilevel</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;binomial&quot;</span><span class="p">,</span> <span class="n">ind</span><span class="o">.</span><span class="n">area</span><span class="o">=</span><span class="n">ind</span><span class="o">.</span><span class="n">area</span><span class="p">,</span>
                <span class="n">trials</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">sample</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#### Set up a square lattice region</span>
<span class="n">x</span><span class="o">.</span><span class="n">easting</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="p">:</span><span class="mi">10</span>
<span class="n">x</span><span class="o">.</span><span class="n">northing</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="p">:</span><span class="mi">10</span>
<span class="n">Grid</span> <span class="o">&lt;-</span> <span class="n">expand</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">easting</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">northing</span><span class="p">)</span>
<span class="n">K</span> <span class="o">&lt;-</span> <span class="n">nrow</span><span class="p">(</span><span class="n">Grid</span><span class="p">)</span>

<span class="c1">#### set up distance and neighbourhood (W, based on sharing a common border) matrices</span>
<span class="n">distance</span> <span class="o">&lt;-</span> <span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">Grid</span><span class="p">))</span>
<span class="n">W</span> <span class="o">&lt;-</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
<span class="n">W</span><span class="p">[</span><span class="n">distance</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;-</span><span class="mi">1</span> 	
	
<span class="c1">#### Generate the covariates and response data</span>
<span class="n">x1</span> <span class="o">&lt;-</span> <span class="n">rnorm</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
<span class="n">x2</span> <span class="o">&lt;-</span> <span class="n">rnorm</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
<span class="n">theta</span> <span class="o">&lt;-</span> <span class="n">rnorm</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">phi</span> <span class="o">&lt;-</span> <span class="n">mvrnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">rep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">K</span><span class="p">),</span> <span class="n">Sigma</span><span class="o">=</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">distance</span><span class="p">))</span>
<span class="n">logit</span> <span class="o">&lt;-</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">theta</span> <span class="o">+</span> <span class="n">phi</span>
<span class="n">prob</span> <span class="o">&lt;-</span> <span class="n">exp</span><span class="p">(</span><span class="n">logit</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">exp</span><span class="p">(</span><span class="n">logit</span><span class="p">))</span>
<span class="n">trials</span> <span class="o">&lt;-</span> <span class="n">rep</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="n">K</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">&lt;-</span> <span class="n">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="n">prob</span><span class="p">)</span>


<span class="c1">#### Run the BYM model</span>
<span class="n">formula</span> <span class="o">&lt;-</span> <span class="n">Y</span> <span class="o">~</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span>
<span class="c1">## Not run: model &lt;- S.CARbym(formula=formula, family=&quot;binomial&quot;, trials=trials,</span>
<span class="c1">#W=W, burnin=20000, n.sample=100000)</span>
<span class="c1">## End(Not run)</span>

<span class="c1">#### Toy example for checking</span>
<span class="n">model</span> <span class="o">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">CARbym</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;binomial&quot;</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span>
<span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">sample</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="n">model</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="datos-areales-con-inla-markov">
<h1>Datos areales con INLA (Markov)<a class="headerlink" href="#datos-areales-con-inla-markov" title="Permalink to this heading">#</a></h1>
<p>Para ilustrar cómo se ajustan los modelos espaciales con INLA, se utilizará el conjunto de datos de leucemia de Nueva York. Éste ha sido ampliamente analizado en la literatura (ver, por ejemplo, Waller y Gotway, 2004) y está disponible en el paquete <code class="docutils literal notranslate"><span class="pre">DClusterm</span></code>. El conjunto de datos registra una serie de casos de leucemia en el norte del estado de Nueva York a nivel de distrito censal. Algunas de las variables en el conjunto de datos son:</p>
<ul class="simple">
<li><p><strong>Casos:</strong> Número de casos de leucemia en el período 1978-1982.</p></li>
<li><p><strong>POP8:</strong> Población en 1980.</p></li>
<li><p><strong>PCTOWNHOME:</strong> Proporción de personas que son propietarias de su vivienda.</p></li>
<li><p><strong>PCTAGE65P:</strong> Proporción de personas de 65 años o más.</p></li>
<li><p><strong>AVGIDIST:</strong> Distancia inversa promedio al sitio de tricloroetileno (TCE) más cercano.</p></li>
</ul>
<p>Tenga en cuenta que el interés se centra en la exposición al TCE, utilizando AVGIDIST como un indicador de exposición. Las variables PCTOWNHOME y PCTAGE65P actuarán como posibles factores de confusión que deben incluirse en el modelo. Sin embargo, no lo haremos aquí porque queremos probar cómo los efectos espaciales latentes capturan la variación espacial residual.</p>
<p>El conjunto de datos se puede cargar de la siguiente manera:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">library</span><span class="p">(</span><span class="n">spdep</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">DClusterm</span><span class="p">)</span>
<span class="n">data</span><span class="p">(</span><span class="n">NY8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Dado que el interés se centra en estudiar el riesgo de leucemia en el norte del estado de Nueva York, primero se calcula el número esperado de casos. Esto se hace calculando la tasa de mortalidad general (total de casos dividido por la población total) y multiplicándola por la población:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>rate &lt;- sum(NY8$Cases) / sum(NY8$POP8)
NY8$Expected &lt;- NY8$POP8 * rate
</pre></div>
</div>
</div>
</div>
<p>Una vez que se obtiene el número esperado de casos, se puede obtener una estimación aproximada del riesgo con la razón de mortalidad estandarizada (SMR), que se calcula como el número de casos observados dividido por el número de casos esperados.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>NY8$SMR &lt;- NY8$Cases / NY8$Expected
</pre></div>
</div>
</div>
</div>
<p>En epidemiología, es importante producir mapas para mostrar la distribución espacial del riesgo relativo. En este ejemplo, nos centraremos en la ciudad de Syracuse para reducir el tiempo de cómputo necesario para producir el mapa. Por lo tanto, creamos un índice con las áreas de la ciudad de Syracuse:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Subset Syracuse city
syracuse &lt;- which(NY8$AREANAME == &quot;Syracuse city&quot;)
</pre></div>
</div>
</div>
</div>
<p>Un mapa de enfermedades se puede crear simplemente con la función <code class="docutils literal notranslate"><span class="pre">spplot</span></code> (del paquete <code class="docutils literal notranslate"><span class="pre">sp</span></code>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">library</span><span class="p">(</span><span class="n">viridis</span><span class="p">)</span>
<span class="n">spplot</span><span class="p">(</span><span class="n">NY8</span><span class="p">[</span><span class="n">syracuse</span><span class="p">,</span> <span class="p">],</span> <span class="s2">&quot;SMR&quot;</span><span class="p">,</span> <span class="c1">#at = c(0.6, 0.9801, 1.055, 1.087, 1.125, 13),</span>
   <span class="n">col</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="n">rev</span><span class="p">(</span><span class="n">magma</span><span class="p">(</span><span class="mi">16</span><span class="p">)))</span> <span class="c1">#gray.colors(16, 0.9, 0.4))</span>
</pre></div>
</div>
</div>
</div>
<section id="modelos-mixtos-lineales">
<h2>Modelos mixtos lineales<a class="headerlink" href="#modelos-mixtos-lineales" title="Permalink to this heading">#</a></h2>
<p>El primer modelo que consideraremos es un modelo Gausiano sin efectos aleatorios latentes, ya que proporcionará una línea base para comparar con otros modelos. Para ajustar el modelo con INLA, se utiliza la función <code class="docutils literal notranslate"><span class="pre">inla</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">library</span><span class="p">(</span><span class="n">INLA</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>m1 &lt;- inla(Cases ~ 1 + AVGIDIST,
   data = as.data.frame(NY8),
   family = &quot;Gaussian&quot;,verbose=T,
   E = NY8$Expected, control.predictor = list(compute = TRUE),
   control.compute = list(dic = TRUE, waic = TRUE))

summary(m1)
NY8$FIXED.EFF &lt;- m1$summary.fitted[, &quot;mean&quot;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="regresion-con-efectos-aleatorios">
<h2>Regresión con efectos aleatorios<a class="headerlink" href="#regresion-con-efectos-aleatorios" title="Permalink to this heading">#</a></h2>
<p>Se pueden agregar efectos aleatorios latentes al modelo para tener en cuenta la sobredispersión incluyendo efectos aleatorios Gaussianos i.i.d. en el predictor lineal. Para ajustar el modelo con INLA, primero se crea un índice para identificar los efectos aleatorios (ID). Los efectos aleatorios latentes se especifican con la función <code class="docutils literal notranslate"><span class="pre">f</span></code> en INLA:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>NY8$ID &lt;- 1:nrow(NY8)
m2 &lt;- inla(Cases ~ 1 + AVGIDIST + f(ID, model = &quot;iid&quot;),
  data = as.data.frame(NY8), family = &quot;Gaussian&quot;, 
  E = NY8$Expected,
  control.predictor = list(compute = TRUE),
  control.compute = list(dic = TRUE, waic = TRUE))

summary(m2)
NY8$IID.EFF &lt;- m2$summary.fitted[, &quot;mean&quot;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spplot</span><span class="p">(</span><span class="n">NY8</span><span class="p">[</span><span class="n">syracuse</span><span class="p">,</span> <span class="p">],</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;SMR&quot;</span><span class="p">,</span> <span class="s2">&quot;FIXED.EFF&quot;</span><span class="p">,</span> <span class="s2">&quot;IID.EFF&quot;</span><span class="p">),</span>
  <span class="n">col</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="n">rev</span><span class="p">(</span><span class="n">magma</span><span class="p">(</span><span class="mi">16</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="modelos-espaciales-para-datos-tipo-poligonos">
<h2>Modelos espaciales para datos tipo poligonos<a class="headerlink" href="#modelos-espaciales-para-datos-tipo-poligonos" title="Permalink to this heading">#</a></h2>
<p>Los datos discretos (lattice o poligonos regulares o irregulares) involucran datos medidos en diferentes áreas, por ejemplo, vecindarios, ciudades, provincias, estados, etc. La dependencia espacial aparece porque las áreas vecinas mostrarán valores similares de la variable de interés.</p>
<p>Tenemos observaciones <span class="math notranslate nohighlight">\(y = {y_i}_{i=1}^n\)</span> donde n es el número de áreas. A y se le asigna una distribución multivariante que tiene en cuenta la dependencia espacial. Una forma común de describir la proximidad espacial en datos discretos es mediante una matriz de adyacencia W. El elemento <span class="math notranslate nohighlight">\(W_{i,j}\)</span> es distinto de cero si las áreas i y j son vecinas. Por lo general, dos áreas son vecinas si comparten un límite común.</p>
<p>La matriz de adyacencia se puede calcular utilizando la función <code class="docutils literal notranslate"><span class="pre">poly2nb</span></code> en el paquete <code class="docutils literal notranslate"><span class="pre">spdep</span></code>. Esta función considerará dos áreas como vecinas si sus bordes se tocan al menos en un punto (es decir, adyacencia de “Queen”):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NY8</span><span class="o">.</span><span class="n">nb</span> <span class="o">&lt;-</span> <span class="n">poly2nb</span><span class="p">(</span><span class="n">NY8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Esto devolverá un objeto <code class="docutils literal notranslate"><span class="pre">nb</span></code> con la definición de la estructura del vecindario.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NY8</span><span class="o">.</span><span class="n">nb</span>
</pre></div>
</div>
</div>
</div>
<p>Además, estos objetos creados con la función <code class="docutils literal notranslate"><span class="pre">nb</span></code> se pueden visualizar gráficamente cuando se conoce información adicional sobre las áreas, como la ubicación de su centro.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span><span class="p">(</span><span class="n">NY8</span><span class="p">)</span> 
<span class="n">plot</span><span class="p">(</span><span class="n">NY8</span><span class="o">.</span><span class="n">nb</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">(</span><span class="n">NY8</span><span class="p">),</span> <span class="n">add</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">pch</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="modelos-de-regresion">
<h2>Modelos de Regresión<a class="headerlink" href="#modelos-de-regresion" title="Permalink to this heading">#</a></h2>
<p>A menudo, además de <span class="math notranslate nohighlight">\(y_i\)</span>, tenemos una serie de covariables <span class="math notranslate nohighlight">\(X_i\)</span>. Por lo tanto, es posible que deseemos regresionar <span class="math notranslate nohighlight">\(y_i\)</span> en <span class="math notranslate nohighlight">\(X_i\)</span>. Además de las covariables, es posible que queramos tener en cuenta la estructura espacial de los datos. Se pueden utilizar diferentes tipos de modelos de regresión para modelar datos de celosía:</p>
<ul class="simple">
<li><p>Modelos Lineales Generalizados (con efectos aleatorios espaciales)</p></li>
<li><p>Modelos de econometría espacial</p></li>
<li><p>Modelos Lineales Mixtos</p></li>
</ul>
<p>Un enfoque común (para datos Gaussianos) es usar una regresión lineal con efectos aleatorios:</p>
<p><span class="math notranslate nohighlight">\(Y = Xβ + Zu + ε\)</span></p>
<p>El vector de efectos aleatorios <span class="math notranslate nohighlight">\(u\)</span> se modela como una distribución Normal multivariante:</p>
<p><span class="math notranslate nohighlight">\(u ∼ N(0, σ_u^2 Σ)\)</span></p>
<p><span class="math notranslate nohighlight">\(Σ\)</span> se define de manera que induzca una mayor correlación con las áreas adyacentes. Z es una matriz de diseño para los efectos aleatorios y <span class="math notranslate nohighlight">\(ε_i ∼ N(0, σ^2)\)</span>, i = 1, …, n es un término de error.</p>
<p>Los Modelos Lineales Mixtos Generalizados se pueden definir de manera similar utilizando una probabilidad diferente y vinculando el parámetro apropiado al predictor lineal.</p>
<p>Hay muchas formas diferentes de incluir la dependencia espacial en <span class="math notranslate nohighlight">\(Σ\)</span>:</p>
<ul class="simple">
<li><p>Autoregresivo simultáneo (SAR):</p></li>
</ul>
<p><span class="math notranslate nohighlight">\(Σ^{-1} = [(I - ρW)' (I - ρW)]\)</span></p>
<ul class="simple">
<li><p>Autoregresivo condicional (CAR):</p></li>
</ul>
<p><span class="math notranslate nohighlight">\(Σ^{-1} = (I - ρW)\)</span></p>
<ul class="simple">
<li><p>CAR intrínseco (ICAR):</p></li>
</ul>
<p><span class="math notranslate nohighlight">\(Σ^{-1} = diag(n_i) - W\)</span></p>
<p><span class="math notranslate nohighlight">\(n_i\)</span> es el número de vecinos del área i. <span class="math notranslate nohighlight">\(Σ_{i,j}\)</span> depende de una función de d(i,j). Por ejemplo:</p>
<p><span class="math notranslate nohighlight">\(Σ_{i,j} = exp{-d(i,j) / φ}\)</span></p>
<ul class="simple">
<li><p>“Mezcla” de matrices (modelo de Leroux et al.):</p></li>
</ul>
<p><span class="math notranslate nohighlight">\(Σ = [(1 - λ)I_n + λM]^{-1}; λ ∈ (0,1)\)</span></p>
<p>M es la precisión de la especificación ICAR</p>
<p>Las especificaciones CAR e ICAR se han propuesto dentro del campo de la Estadística, mientras que la especificación SAR se acuñó dentro de la Econometría Espacial. Independientemente de su origen, todas las especificaciones aquí presentadas pueden considerarse efectos latentes Gaussianos con una matriz de precisión particular.</p>
</section>
<section id="modelo-icar">
<h2>Modelo ICAR<a class="headerlink" href="#modelo-icar" title="Permalink to this heading">#</a></h2>
<p>El primer ejemplo se basará en la especificación ICAR. Tenga en cuenta que el efecto latente espacial se define usando la función f. Esto requerirá un índice para identificar los efectos aleatorios en cada área, el tipo de modelo y la matriz de adyacencia. Para ello, se utilizará una matriz dispersa.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Create sparse adjacency matrix
NY8.mat &lt;- as(nb2mat(NY8.nb, style = &quot;B&quot;), &quot;Matrix&quot;)
# Fit model
m.icar &lt;- inla(Cases ~ 1 +  AVGIDIST + 
    f(ID, model = &quot;besag&quot;, graph = NY8.mat),
  data = as.data.frame(NY8), E = NY8$Expected, family =&quot;Gaussian&quot;,
  control.predictor = list(compute = TRUE),
  control.compute = list(dic = TRUE, waic = TRUE))

summary(m.icar)
NY8$ICAR &lt;- m.icar$summary.fitted.values[, &quot;mean&quot;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="modelo-bym-besag-york-y-mollie">
<h2>Modelo BYM (Besag, York y Mollié)<a class="headerlink" href="#modelo-bym-besag-york-y-mollie" title="Permalink to this heading">#</a></h2>
<p>El modelo de Besag, York y Mollié incluye dos efectos aleatorios latentes: un efecto latente ICAR y un efecto latente Gaussiano i.i.d. No es necesario definir estos dos efectos latentes si se establece el argumento <code class="docutils literal notranslate"><span class="pre">model</span></code> como “bym” cuando se define el efecto aleatorio latente con la función <code class="docutils literal notranslate"><span class="pre">f</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>m.bym = inla(Cases ~ 1 +  AVGIDIST + 
    f(ID, model = &quot;bym&quot;, graph = NY8.mat),
  data = as.data.frame(NY8), E = NY8$Expected, family =&quot;Gaussian&quot;,
  control.predictor = list(compute = TRUE),
  control.compute = list(dic = TRUE, waic = TRUE))

summary(m.bym)
NY8$BYM &lt;- m.bym$summary.fitted.values[, &quot;mean&quot;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="modelo-de-leroux-et-al">
<h2>Modelo de Leroux et al.<a class="headerlink" href="#modelo-de-leroux-et-al" title="Permalink to this heading">#</a></h2>
<p>Este modelo se define utilizando una “mezcla” de matrices (modelo de Leroux et al.) para definir la matriz de precisión del efecto latente. Este modelo se implementa utilizando el efecto latente <code class="docutils literal notranslate"><span class="pre">generic1</span></code>, que utiliza la siguiente matriz de precisión:</p>
<p><span class="math notranslate nohighlight">\(Σ^{-1} = 1 / τ (I_n - ρ * λ_max * C); ρ ∈ [0,1)\)</span></p>
<p>En esta ecuación, C es una matriz y λ_max su autovalor máximo.</p>
<p>Para definir el modelo correcto, debemos tomar la matriz C de la siguiente manera:</p>
<p><span class="math notranslate nohighlight">\(C = I_n - M; M = diag(n_i) - W\)</span></p>
<p>Entonces, λ_max = 1 y:</p>
<p><span class="math notranslate nohighlight">\(Σ^{-1} = 1 / τ (I_n - ρ * λ_max * C) = 1 / τ (I_n - ρ * (I_n - M)) = 1 / τ ((1 - ρ)I_n + ρM)\)</span></p>
<p>Para ajustar el modelo, el primer paso es crear la matriz M.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ICARmatrix</span> <span class="o">&lt;-</span> <span class="n">Diagonal</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">NY8</span><span class="o">.</span><span class="n">mat</span><span class="p">),</span> <span class="n">apply</span><span class="p">(</span><span class="n">NY8</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">sum</span><span class="p">))</span> <span class="o">-</span> <span class="n">NY8</span><span class="o">.</span><span class="n">mat</span>
<span class="n">Cmatrix</span> <span class="o">&lt;-</span> <span class="n">Diagonal</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">NY8</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>  <span class="n">ICARmatrix</span>
</pre></div>
</div>
</div>
</div>
<p>El modelo se ajusta como de costumbre con la función <code class="docutils literal notranslate"><span class="pre">inla</span></code>. Tenga en cuenta que la matriz C se pasa a la función <code class="docutils literal notranslate"><span class="pre">f</span></code> usando el argumento <code class="docutils literal notranslate"><span class="pre">Cmatrix</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>m.ler = inla(Cases ~ 1 +  AVGIDIST +
    f(ID, model = &quot;generic1&quot;, Cmatrix = Cmatrix),
  data = as.data.frame(NY8), E = NY8$Expected, family =&quot;Gaussian&quot;,
  control.predictor = list(compute = TRUE),
  control.compute = list(dic = TRUE, waic = TRUE))
summary(m.ler)
NY8$LEROUX &lt;- m.ler$summary.fitted.values[, &quot;mean&quot;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="spatial-lag-model-slm">
<h2>Spatial Lag Model (SLM)<a class="headerlink" href="#spatial-lag-model-slm" title="Permalink to this heading">#</a></h2>
<p>Este modelo incluye covariables y un proceso autoregresivo en la respuesta. R-INLA incluye un efecto latente experimental llamado <code class="docutils literal notranslate"><span class="pre">slm</span></code> para ajustar el siguiente modelo:</p>
<p><span class="math notranslate nohighlight">\(x = (In - ρW)^{-1} (Xβ + e)\)</span></p>
<p>Los elementos del modelo son:</p>
<ul class="simple">
<li><p>W: Matriz de adyacencia estandarizada por filas.</p></li>
<li><p>ρ: Parámetro de autocorrelación espacial.</p></li>
<li><p>X: Matriz de covariables, con coeficientes β.</p></li>
<li><p>e: Errores i.i.d. Gaussianos con varianza σ^2.</p></li>
</ul>
<p>El efecto latente <code class="docutils literal notranslate"><span class="pre">slm</span></code> es experimental y se puede combinar con otros efectos en el predictor lineal. Para definir un modelo con el efecto latente <code class="docutils literal notranslate"><span class="pre">slm</span></code> se necesitan los siguientes elementos:</p>
<ul class="simple">
<li><p><strong>X:</strong> Matriz de covariables. Esta matriz contiene los valores de las variables explicativas para cada unidad muestral.</p></li>
<li><p><strong>W:</strong> Matriz de adyacencia estandarizada por filas. Esta matriz describe la estructura espacial del modelo. Un elemento <code class="docutils literal notranslate"><span class="pre">W_ij</span></code> distinto de cero indica que las unidades muestrales <code class="docutils literal notranslate"><span class="pre">i</span></code> y <code class="docutils literal notranslate"><span class="pre">j</span></code> son vecinas, y su valor refleja la fuerza de la vecindad. La estandarización por filas garantiza que la suma de cada fila sea igual a 1.</p></li>
<li><p><strong>Q:</strong> Matriz de precisión de los coeficientes β. Esta matriz define la varianza previa de los coeficientes estimados para las variables explicativas en el modelo.</p></li>
<li><p><strong>Rango de ρ:</strong> Rango del parámetro de autocorrelación espacial <code class="docutils literal notranslate"><span class="pre">ρ</span></code>. Este parámetro controla la fuerza de la dependencia espacial en el modelo. A menudo, el rango de <code class="docutils literal notranslate"><span class="pre">ρ</span></code> se define en base a los autovalores de la matriz de adyacencia <code class="docutils literal notranslate"><span class="pre">W</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#X</span>
<span class="n">mmatrix</span> <span class="o">&lt;-</span> <span class="n">model</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">Cases</span> <span class="o">~</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">AVGIDIST</span><span class="p">,</span> <span class="n">NY8</span><span class="p">)</span>

<span class="c1">#W</span>
<span class="n">W</span> <span class="o">&lt;-</span> <span class="k">as</span><span class="p">(</span><span class="n">nb2mat</span><span class="p">(</span><span class="n">NY8</span><span class="o">.</span><span class="n">nb</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;W&quot;</span><span class="p">),</span> <span class="s2">&quot;Matrix&quot;</span><span class="p">)</span>

<span class="c1">#Q</span>
<span class="n">Q</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">Diagonal</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">ncol</span><span class="p">(</span><span class="n">mmatrix</span><span class="p">),</span> <span class="n">x</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">)</span>

<span class="c1">#Range of rho</span>
<span class="n">rho</span><span class="o">.</span><span class="n">min</span><span class="o">&lt;-</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">rho</span><span class="o">.</span><span class="n">max</span><span class="o">&lt;-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>Los argumentos del efecto latente <code class="docutils literal notranslate"><span class="pre">slm</span></code> se pasan a través del argumento <code class="docutils literal notranslate"><span class="pre">args.sm</span></code>. En este caso, hemos creado una lista con el mismo nombre para mantener juntos todos los valores requeridos:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Arguments for &#39;slm&#39;</span>
<span class="n">args</span><span class="o">.</span><span class="n">slm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
   <span class="n">rho</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">min</span> <span class="p">,</span>
   <span class="n">rho</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
   <span class="n">W</span> <span class="o">=</span> <span class="n">W</span><span class="p">,</span>
   <span class="n">X</span> <span class="o">=</span> <span class="n">mmatrix</span><span class="p">,</span>
   <span class="n">Q</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">beta</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Además, se deben establecer las funciones a priori para el parámetro de precisión τ y el parámetro de autocorrelación espacial ρ:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Prior on rho</span>
<span class="n">hyper</span><span class="o">.</span><span class="n">slm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
   <span class="n">prec</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
      <span class="n">prior</span> <span class="o">=</span> <span class="s2">&quot;loggamma&quot;</span><span class="p">,</span> <span class="n">param</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)),</span>
      <span class="n">rho</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">prior</span> <span class="o">=</span> <span class="s2">&quot;logitbeta&quot;</span><span class="p">,</span> <span class="n">param</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>La definición de la función a priori utiliza una lista con nombre y diferentes argumentos. El argumento <code class="docutils literal notranslate"><span class="pre">prior</span></code> define la distribución a priori que se usará, y el argumento <code class="docutils literal notranslate"><span class="pre">param</span></code> define los parámetros de dicha distribución.</p>
<p>En este caso:</p>
<ul class="simple">
<li><p>Se asigna una función a priori gamma a la precisión, con parámetros 0.01 y 0.01.</p></li>
<li><p>Se asigna una función a priori beta al parámetro de autocorrelación espacial, con parámetros 1 y 1. Esto es equivalente a una distribución uniforme en el intervalo (1, 1).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#SLM model
m.slm &lt;- inla( Cases ~ -1 +
     f(ID, model = &quot;slm&quot;, args.slm = args.slm, hyper = hyper.slm),
   data = as.data.frame(NY8), family = &quot;Gaussian&quot;,
   E = NY8$Expected,
   control.predictor = list(compute = TRUE),
   control.compute = list(dic = TRUE, waic = TRUE)
)

summary(m.slm)
NY8$SLM &lt;- m.slm$summary.fitted.values[, &quot;mean&quot;]
</pre></div>
</div>
</div>
</div>
<p>Los valores estimados de los coeficientes aparecen como parte de los efectos aleatorios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>round(m.slm$summary.random$ID[47:48,], 4)
</pre></div>
</div>
</div>
</div>
<p>La autocorrelación espacial se informa en la escala interna (es decir, entre 0 y 1) y necesita ser reescalada.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>marg.rho.internal &lt;- m.slm$marginals.hyperpar[[&quot;Rho for ID&quot;]]
marg.rho &lt;- inla.tmarginal( function(x) {
  rho.min + x * (rho.max - rho.min)
}, marg.rho.internal)

inla.zmarginal(marg.rho, FALSE)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span><span class="p">(</span><span class="n">marg</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="n">main</span> <span class="o">=</span> <span class="s2">&quot;Spatial autocorrelation&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="resultados">
<h2>Resultados<a class="headerlink" href="#resultados" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spplot</span><span class="p">(</span><span class="n">NY8</span><span class="p">[</span><span class="n">syracuse</span><span class="p">,</span> <span class="p">],</span> 
  <span class="n">c</span><span class="p">(</span><span class="s2">&quot;FIXED.EFF&quot;</span><span class="p">,</span> <span class="s2">&quot;IID.EFF&quot;</span><span class="p">,</span> <span class="s2">&quot;ICAR&quot;</span><span class="p">,</span> <span class="s2">&quot;BYM&quot;</span><span class="p">,</span> <span class="s2">&quot;LEROUX&quot;</span><span class="p">,</span> <span class="s2">&quot;SLM&quot;</span><span class="p">),</span>
  <span class="n">col</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="n">rev</span><span class="p">(</span><span class="n">magma</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="modelos-espaciales-con-spamm">
<h1>Modelos espaciales con spaMM<a class="headerlink" href="#modelos-espaciales-con-spamm" title="Permalink to this heading">#</a></h1>
<section id="modelo-no-espacial">
<h2>Modelo no espacial<a class="headerlink" href="#modelo-no-espacial" title="Permalink to this heading">#</a></h2>
<p>A continuación se presenta un ejemplo donde incluso si hay un patrón espacial en los datos, esto no significa que deban usarse modelos de regresión espacial. En algunos casos, los patrones espaciales en la variable respuesta son generados por patrones espaciales presentes en las covariables, como el gradiente de temperatura, la elevación, etc. Una vez que tomamos en cuenta el efecto de estas covariables, los patrones espaciales en la variable respuesta desaparecen.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># load libraries
library(tidyverse)
library(gridExtra)
library(NLMR)
library(DHARMa)

# simulate a random temperature gradient
temp &lt;- nlm_distancegradient(ncol = 100, nrow = 100, origin = c(1,10,1,10), rescale = TRUE)

# extract the temperature values at 100 random points
dat &lt;- data.frame(x = runif(100,0,100), y = runif(100,0,100))
dat$temperature &lt;- raster::extract(temp, dat)

# simulate tree height
dat$height &lt;- 20 + 35 * dat$temperature + rnorm(100)

# plot spatial pattern in tree height
ggplot(dat, aes(x = x, y = y, size = height)) +
  geom_point() +
  scale_size_continuous(range = c(1,10))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fit a non-spatial model</span>
<span class="n">m_non</span> <span class="o">&lt;-</span> <span class="n">lm</span><span class="p">(</span><span class="n">height</span> <span class="o">~</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">dat</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># formal test
sims &lt;- simulateResiduals(m_non)
testSpatialAutocorrelation(sims, x = dat$x, y = dat$y, plot = FALSE)
</pre></div>
</div>
</div>
</div>
</section>
<section id="modelo-espacial">
<h2>Modelo espacial<a class="headerlink" href="#modelo-espacial" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>library(geoR)
library(viridis)
data(ca20)
# put this in a data frame
dat &lt;- data.frame(x = ca20$coords[,1], y = ca20$coords[,2], calcium = ca20$data, elevation = ca20$covariate[,1], region = factor(ca20$covariate[,2]))

# plot the data
ggplot(dat, aes(x=x, y = y, color =calcium, shape = region)) +
  geom_point() +
  scale_color_viridis(option = &quot;A&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># fit a no-spatial model
m_lm &lt;- lm(calcium ~ elevation + region, dat)
# test for spatial autocorrelation
sims &lt;- simulateResiduals(m_lm)
testSpatialAutocorrelation(sims, dat$x, dat$y, plot = FALSE)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">library</span><span class="p">(</span><span class="n">spaMM</span><span class="p">)</span>
<span class="c1"># fit the model</span>
<span class="n">m_spamm</span> <span class="o">&lt;-</span> <span class="n">fitme</span><span class="p">(</span><span class="n">calcium</span> <span class="o">~</span> <span class="n">elevation</span> <span class="o">+</span> <span class="n">region</span> <span class="o">+</span> <span class="n">Matern</span><span class="p">(</span><span class="mi">1</span> <span class="o">|</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">dat</span><span class="p">,</span> <span class="n">family</span> <span class="o">=</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">)</span> <span class="c1"># this take a bit of time</span>
<span class="c1"># model summary</span>
<span class="n">summary</span><span class="p">(</span><span class="n">m_spamm</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Hay dos salidas principales de interés aquí: la primera son los <strong>efectos fijos (beta)</strong>, que son los parámetros de regresión estimados (pendientes). Luego, el parámetro de correlación <strong>nu</strong> y <strong>rho</strong> que representan la fuerza y la velocidad de decaimiento del efecto espacial. Podemos convertir esto en el efecto de correlación espacial real al graficar la correlación estimada entre dos ubicaciones en función de su distancia.</p>
<p>Aquí desglosamos un poco más la terminología:</p>
<ul class="simple">
<li><p><strong>Efectos fijos (beta):</strong> En este contexto, los efectos fijos se refieren a los coeficientes estimados en la regresión lineal. Representan el cambio promedio en la variable respuesta por unidad de cambio en una variable predictora, suponiendo que todas las demás variables permanecen constantes.</p></li>
<li><p><strong>Parámetro de correlación nu (nu):</strong> Nu es un parámetro que controla la fuerza de la autocorrelación espacial. Un valor de nu cercano a 1 indica una autocorrelación espacial fuerte, mientras que un valor cercano a 0 indica una autocorrelación espacial débil o inexistente.</p></li>
<li><p><strong>Parámetro de correlación rho (rho):</strong> Rho es otro parámetro que controla la autocorrelación espacial, pero también afecta la velocidad a la que la correlación decae con la distancia. Un valor de rho positivo indica una autocorrelación espacial positiva (ubicaciones cercanas tienen valores similares), mientras que un valor negativo indica una autocorrelación espacial negativa (ubicaciones cercanas tienen valores diferentes). El valor absoluto de rho determina la rapidez con que la correlación decae con la distancia. Un valor cercano a 1 indica un decaimiento lento, mientras que un valor cercano a 0 indica un decaimiento rápido.</p></li>
</ul>
<p>En resumen, el análisis proporciona información sobre la relación entre las variables predictoras y la variable respuesta, teniendo en cuenta la autocorrelación espacial. Los efectos fijos (beta) indican la fuerza de las relaciones lineales, mientras que los parámetros nu y rho cuantifican la autocorrelación espacial y su decaimiento con la distancia. Para visualizar completamente el efecto de correlación espacial, se recomienda graficar la correlación estimada entre dos ubicaciones en función de su distancia.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dd</span> <span class="o">&lt;-</span> <span class="n">dist</span><span class="p">(</span><span class="n">dat</span><span class="p">[,</span><span class="n">c</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">)])</span>
<span class="n">mm</span> <span class="o">&lt;-</span> <span class="n">MaternCorr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="mf">0.43</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="k">as</span><span class="o">.</span><span class="n">numeric</span><span class="p">(</span><span class="n">dd</span><span class="p">),</span> <span class="k">as</span><span class="o">.</span><span class="n">numeric</span><span class="p">(</span><span class="n">mm</span><span class="p">),</span> <span class="n">xlab</span> <span class="o">=</span> <span class="s2">&quot;Distance between pairs of location [in m]&quot;</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="s2">&quot;Estimated correlation&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sims</span> <span class="o">&lt;-</span> <span class="n">simulateResiduals</span><span class="p">(</span><span class="n">m_spamm</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">sims</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># the effect of elevation
newdat &lt;- expand.grid(x = 5000, y = 5200, elevation = seq(3, 7, length.out = 10), region = factor(1, levels = c(1:3)))

newdat$calcium &lt;- as.numeric(predict(m_spamm, newdat, re.form = NA)) # re.form = NA used to remove spatial effects
newdat$calcium &lt;- newdat$calcium + mean(c(0,fixef(m_spamm)[3:4])) # to remove region effect
# get 95% confidence intervals around predictions
newdat &lt;- cbind(newdat, get_intervals(m_spamm, newdata = newdat, intervals = &quot;fixefVar&quot;, re.form = NA) + mean(c(0,fixef(m_spamm)[3:4])))


gg1 &lt;- ggplot(dat, aes(x = elevation, y = calcium)) +
  geom_point() +
  geom_path(data = newdat) +
  geom_ribbon(data = newdat, aes(ymin = fixefVar_0.025, ymax = fixefVar_0.975), alpha = 0.2)

# now for region effect
newdat &lt;- data.frame(x = 5000, y = 5200, elevation = mean(dat$elevation), region = factor(1:3)) # averaging out elevation effect
newdat$calcium &lt;- as.numeric(predict(m_spamm, newdat, re.form = NA))
# get 95% CI
newdat &lt;- cbind(newdat,get_intervals(m_spamm, newdata = newdat, intervals = &quot;fixefVar&quot;, re.form = NA))

gg2 &lt;- ggplot(dat, aes(x = region, y = calcium)) +
  geom_jitter() +
  geom_point(data = newdat, color = &quot;red&quot;, size = 2) +
  geom_linerange(data = newdat, aes(ymin = fixefVar_0.025, ymax = fixefVar_0.975), color = &quot;red&quot;)

# plot together
grid.arrange(gg1, gg2, ncol = 2)
</pre></div>
</div>
</div>
</div>
<p>Ahora podemos predecir el efecto de la elevación y la región sobre la variable respuesta, teniendo en cuenta los efectos espaciales.</p>
<p>Esto significa que podemos utilizar el modelo de regresión espacial para estimar el impacto de la elevación y la región en la variable de respuesta, incluso después de considerar la autocorrelación espacial entre las mediciones. Al controlar los efectos espaciales, podemos aislar el efecto directo de la elevación y la región en la variable que estamos estudiando.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>library(fields)
library(raster)
# derive a DEM
elev_m &lt;- Tps(dat[,c(&quot;x&quot;,&quot;y&quot;)], dat$elevation)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>r &lt;- raster(xmn = 4950, xmx = 5970, ymn = 4800, ymx = 5720, resolution = 10)
elev &lt;- interpolate(r, elev_m)

# for the region info use the limits given in ca20
pp &lt;- SpatialPolygons(list(Polygons(list(Polygon(ca20$reg1)), ID = &quot;reg1&quot;),Polygons(list(Polygon(ca20$reg2)), ID = &quot;reg2&quot;), Polygons(list(Polygon(ca20$reg3)), ID = &quot;reg3&quot;)))
region &lt;- rasterize(pp, r)

# predict at any location
newdat &lt;- expand.grid(x = seq(4960, 5960, length.out = 50), y = seq(4830, 5710, length.out = 50))
newdat$elevation &lt;- extract(elev, newdat[,1:2])
newdat$region &lt;- factor(extract(region, newdat[,1:2]))
# remove NAs
newdat &lt;- na.omit(newdat)
# predict
newdat$calcium &lt;- as.numeric(predict(m_spamm, newdat))

(gg_spamm &lt;- ggplot(newdat,aes(x=x, y=y, fill = calcium)) +
  geom_raster() +
  scale_fill_viridis())
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Modelos Multinivel</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#datos-areales-con-inla-markov">Datos areales con INLA (Markov)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelos-mixtos-lineales">Modelos mixtos lineales</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#regresion-con-efectos-aleatorios">Regresión con efectos aleatorios</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelos-espaciales-para-datos-tipo-poligonos">Modelos espaciales para datos tipo poligonos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelos-de-regresion">Modelos de Regresión</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-icar">Modelo ICAR</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-bym-besag-york-y-mollie">Modelo BYM (Besag, York y Mollié)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-de-leroux-et-al">Modelo de Leroux et al.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-lag-model-slm">Spatial Lag Model (SLM)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resultados">Resultados</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelos-espaciales-con-spamm">Modelos espaciales con spaMM</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-no-espacial">Modelo no espacial</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-espacial">Modelo espacial</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Edier V. Aristizábal G.
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>